/**
 * --- State & DB Management ---
 */
const DB = {
    save: (key, data) => localStorage.setItem(`biz_app_${key}`, JSON.stringify(data)),
    load: (key) => JSON.parse(localStorage.getItem(`biz_app_${key}`)) || []
};

let clients = DB.load('clients');
let history = DB.load('history');
let currentView = 'dashboard';
let activeClientIndex = null;
let docSearchTerm = '';

// × ×ª×•× ×™ ×“×•×’××” ×¨××©×•× ×™×™×
if (clients.length === 0) {
    clients = [{ name: '×™×©×¨××œ ×™×©×¨××œ×™', phone: '050-1234567', email: 'israel@test.com' }];
    DB.save('clients', clients);
}

/**
 * --- Workflow Logic ---
 */

function getNextDocType(currentType) {
    if (currentType === '×”×¦×¢×ª ××—×™×¨') return '×—×©×‘×•× ×™×ª ××¡';
    if (currentType === '×—×©×‘×•× ×™×ª ××¡') return '×§×‘×œ×”';
    return null; 
}

function promoteDocument(historyIndex) {
    const doc = history[historyIndex];
    const nextType = getNextDocType(doc.type);

    if (!nextType) {
        doc.paid = !doc.paid;
        DB.save('history', history);
        render();
        return;
    }

    showModal(
        `×§×™×“×•× ××¡××š`,
        `×”×× ×œ×”×¤×•×š ××ª ×”${doc.type} ×œ-${nextType}?`,
        () => {
            doc.type = nextType;
            if (nextType === '×§×‘×œ×”') doc.paid = true;
            DB.save('history', history);
            render();
        },
        'ğŸ”„'
    );
}

function addDocument(clientName, type, amount) {
    if (!amount || amount <= 0) return;
    const newDoc = {
        client: clientName,
        type: type,
        total: parseFloat(amount),
        date: new Date().toLocaleDateString('he-IL'),
        paid: type === '×§×‘×œ×”'
    };
    history.push(newDoc);
    DB.save('history', history);
    render();
}

/**
 * --- UI Helpers ---
 */

function showModal(title, body, onConfirm, icon = 'â“') {
    const container = document.getElementById('modal-container');
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-body').innerText = body;
    document.getElementById('modal-icon').innerText = icon;
    
    container.classList.remove('hidden');
    
    const confirmBtn = document.getElementById('modal-confirm');
    const cancelBtn = document.getElementById('modal-cancel');

    const close = () => container.classList.add('hidden');
    
    confirmBtn.onclick = () => { onConfirm(); close(); };
    cancelBtn.onclick = close;
}

function navigate(view, params = null) {
    currentView = view;
    if (view === 'client-detail') activeClientIndex = params;
    docSearchTerm = ''; // ××™×¤×•×¡ ×—×™×¤×•×© ×‘××¢×‘×¨ ×“×£
    render();
}

function updateSearch(val) {
    docSearchTerm = val;
    render();
}

function saveNewClient() {
    const name = document.getElementById('c-name').value;
    const phone = document.getElementById('c-phone').value;
    const email = document.getElementById('c-email').value;

    if (!name) return;
    clients.push({ name, phone, email });
    DB.save('clients', clients);
    navigate('dashboard');
}

/**
 * --- Render Functions ---
 */

function renderDashboard() {
    const main = document.getElementById('main-content');
    const nav = document.getElementById('nav-actions');
    
    nav.innerHTML = `<button onclick="navigate('add-client')" class="btn btn-primary">+ ×œ×§×•×— ×—×“×©</button>`;
    
    main.innerHTML = `
        <h2 class="text-xl font-bold mb-4">×¨×©×™××ª ×œ×§×•×—×•×ª</h2>
        <div class="grid gap-4">
            ${clients.map((c, i) => `
                <div onclick="navigate('client-detail', ${i})" class="card cursor-pointer hover:border-blue-300 border border-transparent flex justify-between items-center transition-all">
                    <div>
                        <h3 class="font-bold text-lg text-slate-800">${c.name}</h3>
                        <p class="text-sm text-slate-500">${c.phone} | ${c.email}</p>
                    </div>
                    <div class="text-blue-500 font-bold">×¦×¤×™×™×” ></div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderClientDetail(index) {
    activeClientIndex = index;
    const client = clients[index];
    const main = document.getElementById('main-content');
    const nav = document.getElementById('nav-actions');

    const clientDocs = history.filter(h => h.client === client.name);
    const filteredDocs = clientDocs.filter(d => 
        d.type.includes(docSearchTerm) || d.total.toString().includes(docSearchTerm)
    );

    const paidTotal = clientDocs.filter(d => d.paid).reduce((sum, d) => sum + d.total, 0);
    const pendingTotal = clientDocs.filter(d => !d.paid).reduce((sum, d) => sum + d.total, 0);

    nav.innerHTML = `<button onclick="navigate('dashboard')" class="btn btn-ghost">< ×—×–×¨×”</button>`;

    main.innerHTML = `
        <div class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">${client.name}</h2>
                <p class="text-slate-500">${client.email} | ${client.phone}</p>
            </div>
            <div class="flex gap-4">
                <div class="text-center bg-emerald-50 p-2 px-4 rounded-lg border border-emerald-100">
                    <p class="text-xs text-emerald-600 font-bold">×©×•×œ×</p>
                    <p class="text-lg font-bold text-emerald-700">â‚ª${paidTotal.toLocaleString()}</p>
                </div>
                <div class="text-center bg-orange-50 p-2 px-4 rounded-lg border border-orange-100">
                    <p class="text-xs text-orange-600 font-bold">×™×ª×¨×”</p>
                    <p class="text-lg font-bold text-orange-700">â‚ª${pendingTotal.toLocaleString()}</p>
                </div>
            </div>
        </div>

        <div class="card mb-6 bg-slate-50 border-dashed border-2 border-slate-200 shadow-none">
            <h3 class="font-bold mb-3 text-slate-700">×”×¤×§×ª ××¡××š ××”×™×¨×”</h3>
            <div class="flex flex-wrap gap-2">
                <input id="new-doc-amount" type="number" placeholder="×¡×›×•× (â‚ª)" class="border p-2 rounded w-32 focus:ring-2 focus:ring-blue-400 outline-none">
                <button onclick="addDocument('${client.name}', '×”×¦×¢×ª ××—×™×¨', document.getElementById('new-doc-amount').value)" class="btn bg-white text-blue-600 border border-blue-100 hover:bg-blue-50">×”×¦×¢×ª ××—×™×¨</button>
                <button onclick="addDocument('${client.name}', '×—×©×‘×•× ×™×ª ××¡', document.getElementById('new-doc-amount').value)" class="btn bg-white text-indigo-600 border border-indigo-100 hover:bg-indigo-50">×—×©×‘×•× ×™×ª ××¡</button>
                <button onclick="addDocument('${client.name}', '×§×‘×œ×”', document.getElementById('new-doc-amount').value)" class="btn bg-white text-emerald-600 border border-emerald-100 hover:bg-emerald-50">×§×‘×œ×”</button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-700">×”×™×¡×˜×•×¨×™×™×ª ××¡××›×™×</h3>
            <input oninput="updateSearch(this.value)" value="${docSearchTerm}" type="text" placeholder="×—×™×¤×•×© ××¡××š..." class="border rounded-lg p-1 px-3 text-sm focus:ring-2 focus:ring-blue-400 outline-none w-48">
        </div>

        <div class="space-y-3">
            ${filteredDocs.length === 0 ? '<p class="text-center py-8 text-slate-400 italic">××™×Ÿ ××¡××›×™× ×œ×”×¦×’×”</p>' : ''}
            ${filteredDocs.map((h) => {
                const hIdx = history.findIndex(item => item === h);
                const nextStep = getNextDocType(h.type);
                return `
                    <div class="card flex justify-between items-center border-r-4 ${h.paid ? 'border-emerald-500' : 'border-orange-500'}">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold">${h.date}</p>
                            <h4 class="font-bold text-slate-800">${h.type}</h4>
                            <p class="text-sm font-bold text-slate-600">â‚ª${h.total.toLocaleString()}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="badge ${h.paid ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-700'}">
                                ${h.paid ? '×©×•×œ×' : '×××ª×™×Ÿ'}
                            </span>
                            <button onclick="promoteDocument(${hIdx})" class="btn btn-ghost text-xs ${nextStep ? 'text-blue-600' : 'text-slate-400'}">
                                ${nextStep ? `×”××¨ ×œ-${nextStep} ğŸ”„` : (h.paid ? '×¡××Ÿ ×›×œ× ×©×•×œ×' : '×¡××Ÿ ×›×©×•×œ×')}
                            </button>
                        </div>
                    </div>
                `;
            }).reverse().join('')}
        </div>
    `;
}

function renderAddClient() {
    const main = document.getElementById('main-content');
    const nav = document.getElementById('nav-actions');
    nav.innerHTML = `<button onclick="navigate('dashboard')" class="btn btn-ghost">< ×—×–×¨×”</button>`;
    
    main.innerHTML = `
        <div class="card max-w-md mx-auto">
            <h2 class="text-xl font-bold mb-4 text-slate-800">×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1 text-slate-600">×©× ××œ×</label>
                    <input id="c-name" type="text" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-slate-600">×˜×œ×¤×•×Ÿ</label>
                    <input id="c-phone" type="text" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-slate-600">××™××™×™×œ</label>
                    <input id="c-email" type="email" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-400 outline-none">
                </div>
                <button onclick="saveNewClient()" class="btn btn-primary w-full mt-4 py-3">×©××•×¨ ×œ×§×•×—</button>
            </div>
        </div>
    `;
}

function render() {
    if (currentView === 'dashboard') renderDashboard();
    else if (currentView === 'client-detail') renderClientDetail(activeClientIndex);
    else if (currentView === 'add-client') renderAddClient();
}

// ×”×¤×¢×œ×” ×¨××©×•× ×™×ª
window.onload = render;

        <script src="storage.js"></script>
<script src="app.js"></script>

×•×œ××—×¨ ××›×Ÿ, ×‘×ª×•×š `app.js`, ×ª×•×›×œ ×œ×”×—×œ×™×£ ××ª ×”×§×¨×™××•×ª ×”×™×©×™×¨×•×ª ×œ-`localStorage` ×‘×©×™××•×© ×‘-`StorageService`. ×œ×“×•×’××”:
* ×‘××§×•× `DB.load('clients')` ×”×©×ª××© ×‘-`StorageService.getClients()`.
* ×‘××§×•× `DB.save(...)` ×”×©×ª××© ×‘-`StorageService.addDocument(...)`.

×–×” ×”×•×¤×š ××ª ×”×§×•×“ ×©×œ×š ×œ×”×¨×‘×” ×™×•×ª×¨ ×§×¨×™× ×•×§×œ ×œ×ª×—×–×•×§×”!
